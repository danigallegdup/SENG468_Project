name: Backend CI

on:
  pull_request:
    branches:
      - '**'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Create .env file
      run: |
        echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

    - name: Run docker compose
      run: docker-compose -f docker-compose.yml up --build -d

    - name: Install JMeter
      run: sudo apt-get install -y jmeter

    - name: Create JMeter configuration directory
      run: sudo mkdir -p /etc/jmeter

    - name: Copy custom JMeter properties
      run: sudo cp custom_jmeter.properties /etc/jmeter/jmeter.properties

    - name: Run sample_test_script2
      run: jmeter -n -t ./Sample_test_script2.jmx -l log.jtl
    
    - name: Archive log file and upload to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: log
        path: log.jtl

    - name: Make sure test passed
      run: |
        if grep -q "false" log.jtl; then
          echo "Test failed"
          exit 1
        else
          echo "Test passed"
        fi
    
    - name: Stop docker compose
      run: docker-compose -f docker-compose.yml down